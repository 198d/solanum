#!/usr/bin/env ruby

require 'optparse'

$options = {
  riemann_host: 'localhost',
  riemann_port: 5555,
  event_host: %x{hostname --fqdn}.chomp,
  interval: 5,
  tags: [],
  ttl: 10,
  verbose: false,
}

# Parse command-line options.
options = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [options] <monitor config> [monitor config] ..."
  opts.separator ""
  opts.separator "Options:"
  opts.on('-h', '--host HOST', "Riemann host (default: #{$options[:riemann_host]})") {|v| $options[:riemann_host] = v }
  opts.on('-p', '--port PORT', "Riemann port (default: #{$options[:riemann_port]})") {|v| $options[:riemann_port] = v.to_i }
  opts.on('-e', '--event-host HOST', "Event hostname (default: #{$options[:event_host]})") {|v| $options[:event_host] = v }
  opts.on('-i', '--interval SECONDS', "Seconds between updates (default: #{$options[:interval]})") {|v| $options[:interval] = v.to_i }
  opts.on('-t', '--tag TAG', "Tag to add to events (may be given multiple times)") {|v| $options[:tags] << v }
  opts.on('-l', '--ttl SECONDS', "Default TTL for events (default: #{$options[:ttl]})") {|v| $options[:ttl] = v.to_i }
  opts.on('-v', '--verbose', "Print additional information to stdout") { $options[:verbose] = true }
  opts.on(      '--help', "Displays usage information") { print opts; exit }
end
options.parse!

# check usage
if ARGV.empty?
  print options
  exit 1
end

$scripts = ARGV.dup

def log(msg)
  puts msg if $options[:verbose]
end



##### MONITORING CONFIGS #####

$: << File.expand_path("../../lib", __FILE__)

require 'solanum'

$sources, $services = Solanum.load($scripts)

if $sources.empty?
  STDERR.puts "No sources loaded!"
  exit 1
end



##### REPORT LOOP #####

require 'riemann/client'

$riemann = Riemann::Client.new host: $options[:riemann_host], port: $options[:riemann_port]
$metrics = {}

loop do
  metrics = Solanum.collect($sources)
  events = Solanum.build($services, $metrics, metrics, $options)

  events.each do |event|
    log "%-40s %5s (%s) %s" % [
      event[:service], event[:value],
      event[:state].nil? ? "--" : event[:state],
      event[:tags].join(' ')
    ]

    $riemann << event
  end

  $metrics = metrics
  sleep $options[:interval]
end
